var app = require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);
var googl = require('goo.gl');
var ctylongpart1 = 'http://closertoyes.com/whoknockedme/?url=';
var ctylongpart2 = '&liid=http://linkedin.com/in/kmcdonald&company=http://closertoyes.com';
var ctylongall = 'startlong';

var q = require('q');
var fs = require('fs');
var $ = require('cheerio');
var request = require('request');

var googl = require('goo.gl');
var google = require('google');
google.resultsPerPage = 20;
//google.pages = 2;
var nextCounter = 0;
var novelText = '';

googl.setKey('AIzaSyAZn3uRKIQ1HDIsFvQEDayS8xh6YhlmHYw');

googl.getKey();

app.get('/', function(req, res){
  res.sendFile(__dirname + '/emailquery.html');
});


io.on('connection', function(socket){
   socket.on('chat message', function(msg){
                        var citylongall = '';
                        var querythis = msg;
io.to(socket.id).emit('chat message', 'working....');
console.log('this is is' + querythis);

                          google(querythis, function(err, next, links){
                            if (err) console.log(err);
                            var emaillistarray = [];
                            for (var i = 0; i < links.length; ++i) {
    					   ctylongall = links[i].description;
                            var emailthis = extractEmails(ctylongall);
                            console.log(emailthis);
//                            emaillistarray[i] = emailthis;
//                            unique(emaillistarray);
                            io.to(socket.id).emit('chat message', emailthis);
  						}
						  if (nextCounter < 10) {
   							 nextCounter += 1;
 							   if (next) next();
						   }
  						fs.writeFile('story.md', novelText, function(err) {
    						if (err) {
     						 throw err;
    						}
						  });
						});
  })
});
http.listen(3000, function(){
  console.log('listening on *:3000');
});


function extractEmails ( text ){
    return text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
    }
function unique(list) {
		var result = [];
		$.each(list, function(i, e) {
			if ($.inArray(e, result) == -1) result.push(e);
		});
		return result;
}
