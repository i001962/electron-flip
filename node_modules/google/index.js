var app = require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);

var googl = require('goo.gl');

var ctylongpart1 = 'http://closertoyes.com/whoknockedme/?url=';
var ctylongpart2 = '&liid=http://linkedin.com/in/kmcdonald&company=http://closertoyes.com'; 
var ctylongall = 'startlong';


// Set a developer key (see http://goo.gl/4DvFk for more info.)
googl.setKey('AIzaSyAZn3uRKIQ1HDIsFvQEDayS8xh6YhlmHYw');

// Get currently set developer key
googl.getKey();

app.get('/', function(req, res){
  res.sendFile(__dirname + '/index.html');
});

io.on('connection', function(socket){
   socket.on('chat message', function(msg){
//                        msg = ctylongpart1 + msg + ctylongpart2
   			googl.shorten(msg)
   				 .then(function (shorten) {	
        		     console.log(msg)
                             io.to(socket.id).emit('chat message', shorten);
                            // io.emit('chat message', shorten);
        		     return msg;
    			})
                .then(function (shorten) {
                     console.log('shortened async' + shorten);
                })
                .catch(function (err) {
                     console.log(err.message);
                })
  		    })

});

http.listen(3000, function(){
  console.log('listening on *:3000');
});
